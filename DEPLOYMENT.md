# BeanGo Deployment Guide - Render.com

This guide walks through deploying BeanGo to Render.com with Firebase Authentication and Neon PostgreSQL.

## Prerequisites

- GitHub account with access to `andelia22/Beango` repository
- Firebase project: `beango-3e2b4` (already configured)
- Neon PostgreSQL production database (separate from dev database)
- Custom domain (optional)

## Firebase Credentials Reference

You'll need these 6 environment variables for Render. Get them from your Firebase Console and Replit secrets:

### Backend Credentials (Firebase Admin SDK)
1. **FIREBASE_PROJECT_ID** - Your Firebase project ID (`beango-3e2b4`)
2. **FIREBASE_CLIENT_EMAIL** - Service account email from Firebase Console → Project Settings → Service Accounts
3. **FIREBASE_PRIVATE_KEY** - Service account private key (include quotes and newlines as-is)

### Frontend Credentials (Firebase Client SDK)
4. **VITE_FIREBASE_API_KEY** - Web API key from Firebase Console → Project Settings → General
5. **VITE_FIREBASE_PROJECT_ID** - Same as FIREBASE_PROJECT_ID
6. **VITE_FIREBASE_APP_ID** - Web app ID from Firebase Console → Project Settings → General

**Note:** All these values are already configured in your Replit secrets. You can copy them from there.

## Step-by-Step Deployment

### 1. Create Render Web Service

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click **"New +"** → **"Web Service"**
3. Connect your GitHub repository: `andelia22/Beango`
4. Configure the service:
   - **Name:** `beango` (or your preferred name)
   - **Runtime:** `Node`
   - **Build Command:** `npm install --include=dev && bash scripts/build.sh`
   - **Start Command:** `npm start`
   - **Instance Type:** Free or Starter (upgrade as needed)

### 2. Configure Environment Variables

In the Render service settings, add these environment variables:

#### Database Variables (Neon PostgreSQL)
```
DATABASE_URL=<your-neon-production-database-url>
PGHOST=<your-neon-host>
PGPORT=5432
PGUSER=<your-neon-user>
PGPASSWORD=<your-neon-password>
PGDATABASE=<your-neon-database-name>
```

#### Session Secret
```
SESSION_SECRET=<auto-generated-by-render>
```
*Render will auto-generate this when you select "Generate Value"*

#### Firebase Backend Credentials
```
FIREBASE_PROJECT_ID=beango-3e2b4
FIREBASE_CLIENT_EMAIL=<your-service-account-email>
FIREBASE_PRIVATE_KEY=<your-private-key-with-newlines>
```

#### Firebase Frontend Credentials
```
VITE_FIREBASE_API_KEY=<your-web-api-key>
VITE_FIREBASE_PROJECT_ID=beango-3e2b4
VITE_FIREBASE_APP_ID=<your-web-app-id>
```

**Important:** When entering `FIREBASE_PRIVATE_KEY`, include the entire key exactly as it appears in your Firebase service account JSON, including:
- The BEGIN/END markers
- All newline characters (`\n`)
- Surrounding quotes

Example format:
```
"-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0...\n-----END PRIVATE KEY-----\n"
```

### 3. Configure Firebase Authorized Domains

Once Render gives you a domain (e.g., `beango.onrender.com` or your custom domain):

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select project: `beango-3e2b4`
3. Navigate to **Authentication** → **Settings** → **Authorized domains**
4. Click **"Add domain"**
5. Add your Render domain (e.g., `beango.onrender.com`)
6. If using a custom domain, add that too
7. Click **"Add"**

### 4. Set Up Neon PostgreSQL Production Database

1. Create a new Neon database for production (separate from dev)
2. Note the connection details (host, port, user, password, database name)
3. Add these to Render environment variables (see Step 2)

**Database Schema Setup:**
- The schema will be automatically created on first deployment
- BeanGo uses Drizzle ORM which handles schema creation
- Tables: `users`, `beango_completions`, `sessions`

### 5. Deploy

1. In Render Dashboard, click **"Manual Deploy"** → **"Deploy latest commit"**
2. Monitor the build logs for any errors
3. Wait for deployment to complete (usually 2-5 minutes)

### 6. Verify Deployment

Once deployed, test the following:

1. **Landing Page**
   - Visit your Render URL
   - Verify page loads with "Welcome to BeanGo" heading

2. **Authentication**
   - Click "Sign In with Google"
   - Complete Google sign-in in popup
   - Verify redirect to interests/welcome page
   - Check that your profile shows correct user data

3. **Database Persistence**
   - Create a room and complete a BeanGo
   - Navigate to History page
   - Verify completions are saved and displayed

4. **Session Persistence**
   - Sign in
   - Refresh the page
   - Verify you remain signed in (session cookie working)

### 7. Custom Domain (Optional)

To use your custom domain:

1. In Render Dashboard, go to your service → **Settings** → **Custom Domains**
2. Click **"Add Custom Domain"**
3. Enter your domain (e.g., `beango.yourdomain.com`)
4. Follow DNS configuration instructions (add CNAME record)
5. Wait for DNS propagation (can take 1-48 hours)
6. Add the custom domain to Firebase authorized domains (see Step 3)

## Troubleshooting

### Build Failures

**Error: Cannot find module 'cities.json'**
- Solution: Ensure `scripts/copy-assets.js` runs successfully during build
- Check build logs for "Copying data files and assets..." message

**Error: ENOENT: no such file or directory**
- Solution: Verify `attached_assets/` directory exists in repository
- Ensure `cities.json` is in `server/data/` directory

### Authentication Issues

**Error: auth/unauthorized-domain**
- Solution: Add your Render domain to Firebase authorized domains
- Remember to add both `yourapp.onrender.com` AND custom domain if using one

**Error: 401 Unauthorized on /api/auth/user**
- Solution: Check that all 6 Firebase env vars are set correctly in Render
- Verify `FIREBASE_PRIVATE_KEY` includes newlines and quotes exactly as shown in service account JSON

### Database Connection Issues

**Error: Connection refused / timeout**
- Solution: Verify Neon database allows connections from Render IP addresses
- Check that DATABASE_URL and PG* variables are correct
- Ensure Neon database is not paused (free tier auto-pauses after inactivity)

**Error: relation "users" does not exist**
- Solution: Database schema should auto-create on first run
- If not, check server logs for Drizzle ORM errors
- Verify DATABASE_URL points to correct database

### Session Issues

**Users logged out on every refresh**
- Solution: Check that SESSION_SECRET is set
- Verify connect-pg-simple is connecting to correct database
- Ensure sessions table exists in database

## Monitoring

### Logs
- View real-time logs in Render Dashboard → Logs tab
- Server logs show authentication events, API requests, errors
- Filter by error level to troubleshoot issues

### Metrics
- Render provides CPU, memory, and bandwidth metrics
- Monitor for unusual spikes or errors
- Set up alerts for service downtime

## Updating the Application

Render auto-deploys on every push to the main branch:

1. Make changes to your code
2. Commit and push to GitHub: `git push origin main`
3. Render automatically detects the push and redeploys
4. Monitor the build process in Render Dashboard

**Manual Deploy:**
- Click "Manual Deploy" → "Deploy latest commit" in Render Dashboard

## Environment Variable Management

To update environment variables:

1. Go to Render Dashboard → Your Service → **Environment**
2. Edit the variable value
3. Click **"Save Changes"**
4. **Important:** Render will automatically redeploy when env vars change

## Rollback

If a deployment breaks the app:

1. Go to Render Dashboard → **Events** tab
2. Find the last working deployment
3. Click **"Rollback to this deploy"**

## Production Checklist

Before going live:

- [ ] All 6 Firebase credentials added to Render
- [ ] Production Neon database configured and connection tested
- [ ] Firebase authorized domains include Render URL
- [ ] Custom domain configured (if applicable)
- [ ] Test authentication flow (sign in, sign out, session persistence)
- [ ] Test creating/joining rooms
- [ ] Test completing BeanGos and viewing history
- [ ] Monitor logs for errors during initial traffic
- [ ] Set up monitoring/alerts for uptime

## Support

If you encounter issues not covered here:

1. Check Render build logs for specific error messages
2. Check browser console for frontend errors
3. Verify all environment variables are set correctly
4. Ensure Firebase authorized domains include your production URL
5. Test authentication locally first to isolate Render-specific issues

## Architecture Notes

**Frontend:** React + Vite (compiled to static files in `dist/client`)
**Backend:** Express.js (compiled to `dist/index.js`)
**Database:** Neon PostgreSQL with Drizzle ORM
**Authentication:** Firebase Authentication (Google OAuth)
**Session:** express-session with connect-pg-simple (PostgreSQL storage)
**Assets:** Static images served from `dist/attached_assets/`

The build process:
1. Vite builds frontend → `dist/client/`
2. esbuild bundles backend → `dist/index.js`
3. copy-assets.js copies data files and images → `dist/data/` and `dist/attached_assets/`
4. Production server serves frontend static files and API routes on same port
